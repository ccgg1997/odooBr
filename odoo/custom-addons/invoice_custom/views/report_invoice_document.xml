<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <data>
    <template id="invoice_lines_grouped"
              inherit_id="account.report_invoice_document"
              priority="20">
      <xpath expr="//table[@name='invoice_line_table']/tbody" position="replace">
        <tbody>
          <t t-set="grouped_lines" t-value="o._get_grouped_lines()"/>
          <t t-foreach="grouped_lines" t-as="g">
            <tr>
              <!-- 1) Producto + variantes inline -->
               <td>
                <!-- Mostrar código del producto si existe -->
                <t t-if="g['product'].default_code">
                  <strong>[<span t-esc="g['product'].default_code"/>]</strong>
                  <span class="ms-1" t-esc="g['product'].name"/>
                </t>
                <!-- Si no hay código, solo mostrar el nombre -->
                <t t-else="">
                  <span t-esc="g['product'].name"/>
                </t>
                
                <!-- Variantes -->
                <t t-if="g['variants']">
                  <br/>
                  <small class="d-block text-muted mb-0">
                    Motivos: <span t-esc="g['variants']"/>
                  </small>
                </t>
              </td>
              <!-- 2) Cantidad -->
              <td class="text-end">
                <span t-esc="g['qty']"/> <span t-esc="g['product'].uom_id.name"/>
              </td>
              <!-- 3) Precio unitario -->
              <td class="text-end"
                  t-attf-class="{{ 'd-none d-md-table-cell' if report_type=='html' else '' }}">
                <span t-esc="g['price_unit']"
                      t-options='{"widget":"monetary","display_currency":o.currency_id}'/>
              </td>
              <!-- 4) Impuestos -->
              <td class="text-end"
                  t-attf-class="{{ 'd-none d-md-table-cell' if report_type=='html' else '' }}">
                <span class="text-nowrap" t-esc="', '.join(map(lambda t: t.name, o.env['account.move.line'].browse(0).tax_ids))"/>
              </td>
              <!-- 5) Importe -->
              <td class="text-end">
                <span t-esc="g['subtotal']"
                      t-options='{"widget":"monetary","display_currency":o.currency_id}'/>
              </td>
            </tr>
          </t>
        </tbody>
      </xpath>
    </template>
  </data>
</odoo>
