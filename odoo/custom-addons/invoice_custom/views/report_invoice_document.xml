<?xml version="1.0" encoding="utf-8"?>
<odoo>
  <data>
    <template id="invoice_lines_grouped"
              inherit_id="account.report_invoice_document"
              priority="20">
      
      <!-- Reemplazar encabezado de la tabla -->
      <xpath expr="//table[@name='invoice_line_table']/thead" position="replace">
        <thead>
          <tr>
            <th name="th_description" class="text-start">
              <span>Descripción</span>
            </th>
            <th name="th_quantity" class="text-end">
              <span>Cantidad</span>
            </th>
            <th name="th_priceunit" class="text-end">
              <span>Precio unitario</span>
            </th>
            <th name="th_taxes" class="text-end" 
                t-attf-class="{{ 'd-none d-md-table-cell' if report_type=='html' else '' }}">
              <span>Impuestos</span>
            </th>
            <th name="th_subtotal" class="text-end">
              <span>Importe</span>
            </th>
          </tr>
        </thead>
      </xpath>
      
      <!-- Reemplazar cuerpo de la tabla -->
      <xpath expr="//table[@name='invoice_line_table']/tbody" position="replace">
        <tbody>
          <t t-set="grouped_lines" t-value="o._get_grouped_lines()"/>
          <t t-foreach="grouped_lines" t-as="g">
            <tr>
              <!-- 1) Producto + variantes inline -->
               <td>
                <!-- Mostrar código del producto si existe -->
                <t t-if="g['product'].default_code">
                  <strong>[<span t-esc="g['default_code']"/>]</strong>
                  <span class="ms-1" t-esc="g['product'].name"/>
                </t>
                <!-- Si no hay código, solo mostrar el nombre -->
                <t t-else="">
                  <span t-esc="g['product'].name"/>
                </t>
                
                <!-- Variantes -->
                <t t-if="g['variants']">
                  <br/>
                  <small class="d-block text-muted mb-0">
                    Motivos: <span t-esc="g['variants']"/>
                  </small>
                </t>
              </td>
              <!-- 2) Cantidad -->
              <td class="text-end">
                <span t-esc="g['qty']"/> 
                <t t-if="g.get('uom_id')">
                  <span t-esc="g['uom_id'].name"/>
                </t>
              </td>
              <!-- 3) Precio unitario -->
              <td class="text-end">
                <span t-esc="g['unit_price']"
                      t-options='{"widget":"monetary","display_currency":o.currency_id}'/>
              </td>
              <!-- 4) Impuestos -->
              <td class="text-end"
                  t-attf-class="{{ 'd-none d-md-table-cell' if report_type=='html' else '' }}">
                <t t-if="g.get('tax_ids')">
                  <span class="text-nowrap" t-esc="', '.join(map(lambda t: t.name, g['tax_ids']))"/>
                </t>
                <t t-else="">
                  <span>-</span>
                </t>
              </td>
              <!-- 5) Importe -->
              <td class="text-end">
                <span t-esc="g['subtotal']"
                      t-options='{"widget":"monetary","display_currency":o.currency_id}'/>
              </td>
            </tr>
          </t>
        </tbody>
      </xpath>
    </template>
  </data>
</odoo>
